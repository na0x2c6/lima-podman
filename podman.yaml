vmType: "vz"
mountType: "virtiofs"
memory: "4GiB"

images:
- location: "https://github.com/lima-vm/alpine-lima/releases/download/v0.2.27/alpine-lima-std-3.17.0-x86_64.iso"
  arch: "x86_64"
  digest: "sha512:07b88838734de63edf302a531aaf57f5a48ec31b31b8a95740faa4fac11852b375c5c83180ff34311ee284b8123536b86b70f0606591b1986e9af2268f3ea675"
- location: "https://github.com/lima-vm/alpine-lima/releases/download/v0.2.27/alpine-lima-std-3.17.0-aarch64.iso"
  arch: "aarch64"
  digest: "sha512:b8028c96385ea5be499e37c142cb9e9d9c861f2647ff7f8cceaf867961ef8878e34a8ba0e8cfe2e01ac082191048e7acc30534782b13c5ec4bea53dad5919c33"

mounts:
- location: "~"
- location: "/tmp/lima"
  writable: true
hostResolver:
  enabled: false
dns:
  - 8.8.8.8
  - 8.8.4.4
containerd:
  system: false
  user: false
provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    # for podman v4.5.0 to use sqlite for backend_database
    apk add --repository=https://dl-cdn.alpinelinux.org/alpine/edge/community podman
    # for compatible with the edge version of conmon
    apk add --repository=https://dl-cdn.alpinelinux.org/alpine/edge/main glib-dev

    mkdir -p /etc/containers/containers.conf.d/

    if [[ ! -e /etc/containers/containers.conf.d/local.conf ]] ; then
      cat <<-EOF > /etc/containers/containers.conf.d/local.conf
    [engine]
    database_backend = "sqlite"
    EOF
    fi

    rc-update add cgroups

    if ! egrep -q '^podman_uri' /etc/conf.d/podman ; then
      cat <<-EOF > /etc/conf.d/podman
    podman_uri="unix:///run/user/$LIMA_CIDATA_UID/podman/podman.sock"
    podman_user="$LIMA_CIDATA_USER"
    EOF
    fi

    mkdir -p "/run/user/$LIMA_CIDATA_UID/podman"
    chown -R "$LIMA_CIDATA_USER:$LIMA_CIDATA_USER" "/run/user/$LIMA_CIDATA_UID"

    if [[ ! -e /etc/subuid ]] || ! egrep -q "^$LIMA_CIDATA_USER:" /etc/subuid ; then
      cat <<-EOF > /etc/subuid
    $LIMA_CIDATA_USER:100000:65536
    EOF
    fi

    if [[ ! -e /etc/subgid ]] || ! egrep -q "^$LIMA_CIDATA_USER:" /etc/subgid ; then
      cat <<-EOF > /etc/subgid
    $LIMA_CIDATA_USER:100000:65536
    EOF
    fi

    if [[ ! -e /etc/sysctl.d/local.conf ]] ; then
      cat <<-EOF > /etc/sysctl.d/local.conf
    net.ipv4.ip_unprivileged_port_start=80
    EOF
    fi

    sysctl -p /etc/sysctl.d/local.conf

    if [[ ! -e /etc/security/limits.d/local.conf ]] ; then
      cat <<-EOF > /etc/security/limits.d/local.conf
    *               soft    nofile          unlimited
    *               hard    nofile          unlimited
    *               soft    stack           unlimited
    *               hard    stack           unlimited
    *               soft    memlock         unlimited
    *               hard    memlock         unlimited
    EOF
    fi

    rc-service podman start
probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v podman >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "podman is not installed yet"
      exit 1
    fi
  hint: See "/var/log/cloud-init-output.log" in the guest
env:
  TMPDIR: /tmp
networks:
- vzNAT: true
portForwards:
- guestSocket: "/run/user/{{.UID}}/podman/podman.sock"
  hostSocket: "{{.Dir}}/sock/podman.sock"
message: |
  To run `podman` on the host (assumes podman-remote is installed), run the following commands:
  ------
  podman system connection add lima-{{.Name}} "unix://{{.Dir}}/sock/podman.sock"
  podman system connection default lima-{{.Name}}
  podman{{if eq .HostOS "linux"}} --remote{{end}} run quay.io/podman/hello
  ------
